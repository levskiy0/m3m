# =============================================================================
# M3M - Mini Services Manager
# Docker Compose Configuration
# =============================================================================
#
# Quick Start:
#   docker compose up -d
#
# Create admin user:
#   docker compose exec m3m /app/m3m new-admin admin@example.com yourpassword
#
# View logs:
#   docker compose logs -f m3m
#
# =============================================================================

services:
  m3m:
    image: ghcr.io/levskiy0/m3m:latest
    # For local build, uncomment below and comment out image:
    # build:
    #   context: .
    #   args:
    #     VERSION: ${M3M_VERSION:-latest}
    container_name: m3m
    restart: unless-stopped
    ports:
      - "${M3M_PORT:-3000}:3000"
    environment:
      # Server
      - M3M_SERVER_HOST=0.0.0.0
      - M3M_SERVER_PORT=3000
      - M3M_SERVER_URI=${M3M_URI:-http://localhost:3000}
      # MongoDB
      - M3M_MONGODB_URI=mongodb://mongodb:27017
      - M3M_MONGODB_DATABASE=${M3M_DB_NAME:-m3m}
      # JWT
      - M3M_JWT_SECRET=${M3M_JWT_SECRET:-change-me-in-production}
      - M3M_JWT_EXPIRATION=${M3M_JWT_EXPIRATION:-168h}
      # Paths
      - M3M_STORAGE_PATH=/app/storage
      - M3M_LOGGING_PATH=/app/logs
      - M3M_PLUGINS_PATH=/app/plugins
    volumes:
      - m3m-storage:/app/storage
      - m3m-logs:/app/logs
      - m3m-plugins:/app/plugins
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mongodb:
    image: mongo:7
    container_name: m3m-mongodb
    restart: unless-stopped
    volumes:
      - m3m-mongodb:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Uncomment to expose MongoDB port for external access
    # ports:
    #   - "27017:27017"

volumes:
  m3m-storage:
  m3m-logs:
  m3m-plugins:
  m3m-mongodb:
