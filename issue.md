# m3m

Система которая позволяет создавать мини сервисы/воркеры на JS и запускать их собирая логи, статистику, данные, хранить модели данных в БД.

Система должна быть расширяема `*.so` плагинами которые расширяют RuntimeJS API.

## Стек

- Golang
  - `gingonic`
  - `uber.FX`
  - `slog`
  - `spf13/cast`
  - `github.com/dop251/goja`
  - `jwt`
  - `github.com/spf13/viper`
  - `github.com/golang-jwt/jwt/v5`
- UI
  - `Monaco Editor`
  - `Vite`
  - `React`
  - `Shadcn`
    - https://ui.shadcn.com/docs/registry/mcp (Нужно добавить MCP)
    - https://ui.shadcn.com/docs/components
- MongoDB

Примерный конфиг

``` 
server:
  host: "0.0.0.0"
  port: 3000
  uri: "http://127.0.0.1:3000"

mongodb:
  uri: "mongodb://localhost:27017"
  database: "telegram_bot_farm"

jwt:
  secret: "your-jwt-secret-key-change-in-production"
  expiration: 168h

storage:
  path: "./storage"
```

## Подробное описание

### Администраторы/Пользователи

У системы есть администраторы, первого root пользователя создаем через `cli` -> `>_ m3m new-admin {email} {password}`.
Root пользователь имеет доступ ко всем проектам, и может добавлять администраторов в систему. При добавлении можно назначить права:

- Создание проектов
- Управление пользователями (добавление/удаление/блокировка/редактирование/доступ к проектоам)
- Доступ к проектам
  - Список созданных проектов

Самый первый root пользователь, неудаляемый, им может управлять только он сам.

Пользователи могут менять себе пароль, имя, аватарку.

### Цели

В система можно настроить глобальные цели, которые будут доступны в `runtime` проектов

- Название
- Slug (`{goal-slug}`)
- Цвет (выбор или Нет или из 16 установленных в системе)
- Выбор проектов которым доступно запись в цель (`one to many`)
- Тип
  - Счетчик (просто увеличиваем значение)
  - Счетчик в разрезе дня (значение будет сегментироваться в разрезе дня `2025-01-01 | value = 123`)
- Описание
- `project_ref` - если есть связь с проектом то это цель проекта, если `null` то глобальная 

В Бд должна быть таблица в которой накапливается статистика, и удобный сервис для сбора статистики за период, по выбранным целям и тд;

### Проекты

Когда пользователь создает проект, ему нужно присвоить

- Имя
- Slug (уник)
- Цвет (выбор или Нет или из 16 установленных в системе)

#### Настройки

- Название проекта
- Цвет
- slug (уник)
- Участники проекта (пользователи с доступом к нему, можно дать доступ или отозвать)
- Приватный API ключ (можно обновить)
- Удалить проект (красная зона)


#### Цели

У каждого проекта есть справочник Целей (Добавление/Редактирование/Список/Удаление).
Эти цели будут использоваться для аналитики в проекте.

Ну уровне БД это одна таблица с глобальными целями.

- Название
- Slug (`{project-slug}-{goal-slug}`)
- Цвет (выбор или Нет или из 16 установленных в системе)
- Тип
    - Счетчик
    - Счетчик в разрезе дня
- Описание 

#### Окружение

У проекта можно настроить окружение, это список параметров которые будут доступны в `runtime` (`env.get('...')`).

- Key
- Type
  - String
  - Text
  - Json
  - Integer
  - Float
  - Boolean
- Value


#### Storage

У каждого проекта есть свой storage который будет доступен в `runtime` и функционал `API` файлового менеджера для доступа к нему

- Каталоги
  - Создание каталога
  - Удаление
  - Переименование
- Файлы
  - Загрузка
  - Скачивание
  - Создание
    - Редактирование json, txt, yaml и прочих текстовых форматов 
  - Получение прямой ссылки (сервер генерирует)
  - Переименование 
  - Удаление
- Просмотр и навигация
  - Для картинок можно генерировать превью `50x50`
  - В остальном фронт будет сам подставлять иконку в соответствии с `mime` типом


#### Service Code (Pipeline)

У каждого проекта есть код сервиса на `JS` + `goja`, который будет запускаться в `runtime`.

`pipeline` должен иметь версии, и черновик. 
Опубликована может быть только одна версия. 
Опубликованную версию нельзя редактировать, что бы ее отредактировать нужно сделать новый черновик от нее. 
Можно удалить устаревшие версии.
Для каждой версии можно назначить ветку.


**Как это выглядит на практике:**

Изначально у нас пустой редактор (с пустым шаблоном сервиса). Мы пишем код и жмем сохранить, теперь есть черновик. 
Если мы жмем опубликовать и выбираем теги - `stable`, `not-fix`, `night-build`, `develop`, то текущий черновик становится опубликованной версией с номером 1.

Если мы хотим внести изменения, мы открываем редактор у нас текущая версия как опубликованная, мы жмем - внести изменения:
- Эта версия, поднимет версию при новой публикации `1.1`
- Новый черновик, поднимет версию при новой публикации `2`

Мы всегда можем откатить версию на предыдущую опубликованную (храним в БД только опубликованные и текущий черновик).
























